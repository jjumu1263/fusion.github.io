<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>근골격계 환자 스트레칭 추천</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .container { display: flex; gap: 20px; }
    #inputSection { width: 40%; }
    #resultSection { width: 55%; display: flex; flex-direction: column; gap: 15px; }
    fieldset { padding: 15px; }
    label { display: block; margin-top: 10px; }
    input[type="text"], input[type="number"] { width: 95%; padding: 5px; }
    button { margin-top: 15px; padding: 8px 15px; }
    .card { padding: 15px; border: 1px solid #ccc; border-radius: 10px; white-space: pre-line; max-height: 350px; overflow-y: auto; }
    h3 { margin-bottom: 5px; }
  </style>
</head>
<body>

<div class="container">
  <div id="inputSection">
    <h3>환자 정보 입력</h3>
    <form id="chatForm">
      <fieldset>
        <legend>환자 정보</legend>

        <label for="age">나이</label>
        <input type="number" id="age" name="age" required />

        <label>성별</label>
        <input type="radio" name="sex" value="남" required> 남
        <input type="radio" name="sex" value="여"> 여

        <label for="height">키 (cm)</label>
        <input type="number" id="height" required />

        <label for="weight">체중 (kg)</label>
        <input type="number" id="weight" required />

        <label for="job">직업</label>
        <input type="text" id="job" placeholder="예: 사무직, 교사 등" required />

        <label for="pain">통증 부위 및 질병명</label>
        <input type="text" id="pain" required />

        <label for="painDesc">통증 양상</label>
        <input type="text" id="painDesc" placeholder="예: 뻐근함, 욱신거림" required />

        <label for="stress">스트레스 지수</label>
        <input type="text" id="stress" placeholder="상, 중, 하" required />

        <label for="fatigue">피로도</label>
        <input type="text" id="fatigue" placeholder="상, 중, 하" required />

        <label for="painLevel">통증 단계</label>
        <input type="text" id="painLevel" placeholder="1단계~3단계" required />

        <label for="existing">기존 질환</label>
        <input type="text" id="existing" placeholder="예: 고혈압, 허리디스크" />

        <label>기구 사용 치료 여부</label>
        <input type="radio" name="equipment" value="사용" required> 사용
        <input type="radio" name="equipment" value="미사용"> 미사용

        <label for="equipmentDetail">사용 기구</label>
        <input type="text" id="equipmentDetail" placeholder="예: 탄력밴드, 폼롤러" />

        <button type="submit">검색 + 요약 + 스트레칭 추천</button>
        <button type="reset">취소</button>
      </fieldset>
    </form>
  </div>

  <div id="resultSection">
    <div class="card">
      <h3>검색 요약 (Google + GPT)</h3>
      <div id="searchSummary">검색 요약이 여기에 표시됩니다.</div>
    </div>

    <div class="card">
      <h3>운동/스트레칭 단계</h3>
      <div id="treatmentSteps">운동치료 단계가 여기에 표시됩니다.</div>
    </div>
  </div>
</div>

<script>
const form = document.getElementById("chatForm");

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const age = document.getElementById("age").value;
  const sex = document.querySelector('input[name="sex"]:checked')?.value;
  const height = document.getElementById("height").value;
  const weight = document.getElementById("weight").value;
  const job = document.getElementById("job").value;
  const pain = document.getElementById("pain").value;
  const painDesc = document.getElementById("painDesc").value;
  const stress = document.getElementById("stress").value;
  const fatigue = document.getElementById("fatigue").value;
  const painLevel = document.getElementById("painLevel").value;
  const existing = document.getElementById("existing").value || "없음";
  const equipment = document.querySelector('input[name="equipment"]:checked')?.value;
  const equipmentDetail = document.getElementById("equipmentDetail").value || "없음";

  const searchQuery = `${pain} 운동치료, 스트레칭, 재활`;

  document.getElementById("searchSummary").innerText = "검색 요약 생성 중...";
  document.getElementById("treatmentSteps").innerText = "스트레칭 추천 생성 중...";

  try {
    // 1️⃣ Google 검색
    const googleRes = await fetch("/api/googleSearch", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query: searchQuery })
    });
    const googleData = await googleRes.json();
    const items = googleData.items || [];
    const snippets = items.map(item => `${item.title}\n${item.snippet}`).join("\n\n");

    // 2️⃣ GPT 요약: Google 검색 결과
    const summaryPrompt = `다음 Google 검색 결과를 한국어로 요약하고, 환자의 근골격계 운동치료와 관련된 정보만 정리해줘:\n\n${snippets}`;
    const summaryRes = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: summaryPrompt })
    });
    const summaryData = await summaryRes.json();
    const summaryText = summaryData.choices?.[0]?.message?.content || "검색 요약이 없습니다.";
    document.getElementById("searchSummary").innerText = summaryText;

    // 3️⃣ GPT 운동/스트레칭 추천 (의학적 근거 포함)
    const treatmentPrompt = `
너는 정형외과, 재활의학과, 통증의학과, 류마티스내과에서 근무하는 25년차 의사야. 
근골격계 질환 환자에게 아래 정보를 바탕으로 스트레칭 방법을 의학적 근거와 출처와 함께 알려줘. 
스트레칭은 20분 이하, 2주 플랜으로 작성하고, 하지 말아야 할 행동과 통증 경고를 다른 정보들보다 먼저 알려줘.
질문:
1. 성별: ${sex}
2. 나이: ${age}
3. 키: ${height}cm
4. 체중: ${weight}kg
5. 직업: ${job}
6. 통증 부위: ${pain}
7. 통증 양상: ${painDesc}
8. 스트레스 지수: ${stress}
9. 피로도: ${fatigue}
10. 통증 단계: ${painLevel}
11. 기존 질환: ${existing}
12. 기구 사용 여부: ${equipment}
13. 기구 종류: ${equipmentDetail}
`;

    const treatmentRes = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: treatmentPrompt })
    });
    const treatmentData = await treatmentRes.json();
    const treatmentText = treatmentData.choices?.[0]?.message?.content || "스트레칭 단계가 없습니다.";
    document.getElementById("treatmentSteps").innerText = treatmentText;

  } catch (err) {
    document.getElementById("searchSummary").innerText = "검색 요약 에러: " + err;
    document.getElementById("treatmentSteps").innerText = "스트레칭 추천 에러: " + err;
  }
});
</script>

</body>
</html>

