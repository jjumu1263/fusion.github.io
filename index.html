<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ChatGPT + Google 운동치료 요약</title>
  <style>
    body { font-family: Arial; margin: 20px; display: flex; }
    #inputSection { width: 40%; }
    #resultSection { width: 55%; margin-left: 5%; }
    fieldset { padding: 15px; }
    label { display: block; margin-top: 10px; }
    input[type="text"] { width: 95%; padding: 5px; }
    button { margin-top: 15px; padding: 8px 15px; }
    #googleResults, #chatResult { margin-top: 10px; padding: 10px; border: 1px solid #ccc; white-space: pre-line; }
  </style>
</head>
<body>

<div id="inputSection">
  <h3>환자 정보 입력</h3>
  <form id="chatForm">
    <fieldset>
      <legend>환자 정보</legend>

      <label for="age">나이</label>
      <input type="text" id="age" name="age_id" required />

      <label>성별</label>
      <input type="radio" name="sex_id" value="남" required> 남
      <input type="radio" name="sex_id" value="여"> 여

      <label for="pain">통증부위 및 질병명</label>
      <input type="text" id="pain" name="pain_id" required />

      <button type="submit">검색 + 요약</button>
      <button type="reset">취소</button>
    </fieldset>
  </form>
</div>

<div id="resultSection">
  <h3>Google 검색 결과</h3>
  <div id="googleResults">검색 결과가 여기에 표시됩니다.</div>
  <h3>ChatGPT 요약</h3>
  <div id="chatResult">요약 결과가 여기에 표시됩니다.</div>
</div>

<script>
  const form = document.getElementById("chatForm");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const age = document.getElementById("age").value;
    const sex = document.querySelector('input[name="sex_id"]:checked')?.value;
    const pain = document.getElementById("pain").value;

    const searchQuery = `${age}세 ${sex} 환자, 통증부위/질병: ${pain}`;

    document.getElementById("googleResults").innerText = "검색 중...";
    document.getElementById("chatResult").innerText = "요약 준비 중...";

    try {
      // 1️⃣ Google 검색
      const googleRes = await fetch("/api/googleSearch", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: searchQuery })
      });
      const googleData = await googleRes.json();
      const items = googleData.items || [];
      const snippets = items.map(item => `${item.title}\n${item.snippet}\n${item.link}`).join("\n\n");
      document.getElementById("googleResults").innerText = snippets || "검색 결과가 없습니다.";

      // 2️⃣ ChatGPT 요약
      const chatPrompt = `다음 검색 결과를 한국어로 요약하고 운동치료 관련 조언을 단계별로 알려줘:\n\n${snippets}`;
      const chatRes = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: chatPrompt })
      });
      const chatData = await chatRes.json();
      if (chatData.choices?.length > 0) {
        document.getElementById("chatResult").innerText = chatData.choices[0].message.content;
      } else {
        document.getElementById("chatResult").innerText = "ChatGPT 요약이 없습니다.";
      }

    } catch (err) {
      document.getElementById("googleResults").innerText = "검색 에러: " + err;
      document.getElementById("chatResult").innerText = "ChatGPT 요약 에러: " + err;
    }
  });
</script>

</body>
</html>
